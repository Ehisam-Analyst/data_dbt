WITH 
all_eligible_customers AS (
SELECT 
    * 
FROM 
    pora-academy-cohort3.jubilee_groceries.promo_eligible_customers
),
converted_customers AS (
SELECT 
    DISTINCT pi.customer_id
    FROM pora-academy-cohort3.jubilee_groceries.parent_invoice pi
    WHERE pi.promo_code <> 0
),
conversion_metrics AS (
SELECT 
    COUNT(DISTINCT e.customer_id) AS eligible_customers,
    COUNT(DISTINCT c.customer_id) AS converted_customers,
    ROUND((COUNT(DISTINCT c.customer_id) / NULLIF(COUNT(DISTINCT e.customer_id), 0) * 100.0 ), 2) AS conversion_rate 
FROM 
    all_eligible_customers e 
LEFT JOIN 
    converted_customers c 
    ON c.customer_id = e.customer_id
)

SELECT 
    i.customer_id,
    i.parent_invoice_id,
    COUNT(i.id) AS no_of_purchases_made,
    pi.promo_code,
    FORMAT_DATE('%B', i.created_on) AS order_month, 
    EXTRACT(QUARTER FROM i.created_on) AS order_quarter, 
    EXTRACT(YEAR FROM i.created_on) AS order_year,  
    SUM(i.quantity) AS quantity_purchased,
    SUM(i.quantity * pbt.product_price) revenue,
    SUM(i.quantity * pbt.product_price) * c.discount discounted_amount,
    SUM(i.quantity * pbt.product_price) - c.discount net_revenue, 
FROM 
    pora-academy-cohort3.jubilee_groceries.invoice i
JOIN 
    pora-academy-cohort3.jubilee_groceries.parent_invoice pi
    ON 
    i.parent_invoice_id = pi.id
JOIN 
    pora-academy-cohort3.jubilee_groceries.product_base_table pbt
    ON 
    i.product_id = pbt.product_id
LEFT JOIN 
    pora-academy-cohort3.jubilee_groceries.cost_joins c
    ON EXTRACT(YEAR FROM i.created_on) = c.year
    AND FORMAT_DATE('%B', i.created_on) = c.month
GROUP BY 
    i.customer_id,
    i.parent_invoice_id,
    pi.promo_code,
    FORMAT_DATE('%B', i.created_on),  
    EXTRACT(YEAR FROM i.created_on),
    EXTRACT(QUARTER FROM i.created_on),
    c.discount
ORDER BY 
    order_year DESC,  
    order_quarter ASC;